name: Deploy Version

on:
  # workflow_dispatch:
    # Note: maintained here for future use and QA/Prod testing with workflows:
    # - call-workflow-dpi-qa
    # - call-workflow-dpi-prod
    #
    # inputs:
    #   environment:
    #     description: 'environments: qa/prod'
    #     required: true
    #     type: choice
    #     options:
    #       - qa
    #       - prod
    #   app_code:
    #     description: 'Application 4 letter Shortcode'
    #     required: true
    #     type: string
    #   functional_area:
    #     description: 'functionalarea: Global Services/DataOps/IT/M&Q/R&D'
    #     required: true
    #     type: choice
    #     options:
    #       - commercial
    #       - dataops
    #       - it
    #       - global services
    #       - m&q
    #       - r&d
    #   data_product_name:
    #     description: 'dataproductname: Service Management'
    #     required: true
    #     default: "Service Management"
    #     type: string
    #   admins:
    #     description: 'valid elanco email id of the admins'
    #     required: true
    #     type: string
    #   developers:
    #     description: 'valid elanco email id of the developers'
    #     required: true
    #     type: string

  push:
    branches:
      - main

  pull_request:
    branches:
      - master

  pull_request_review:
    types:
      - submitted

jobs:
  version:
    name: Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.versioning.outputs.version }}
      changelog: ${{ steps.versioning.outputs.changelog }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up git-cliff
        uses: kenji-miyake/setup-git-cliff@v2
        with:
          version: "2.2.2"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate changelog & bump version
        id: versioning
        shell: bash
        run: |
          # Bump Version
          echo "version=$(git cliff -c .github/actions/github-bump-release/cliff.toml --bumped-version)" >> $GITHUB_OUTPUT

          # Generate changelog
          git cliff \
            -c .github/actions/github-bump-release/cliff.toml \
            --unreleased  \
            --output CHANGELOG.md \
            -vv
          changelog=$(cat CHANGELOG.md)
          rm CHANGELOG.md

          # Output multiline strings: https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#multiline-strings
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "changelog<<$EOF" >> $GITHUB_OUTPUT
          echo "$changelog" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: Push Release to GitHub repo
        shell: bash
        run: |
          echo "$CHANGELOG" >> CHANGELOG.md
          gh release create $VERSION --notes-file CHANGELOG.md
        env:
          CHANGELOG: ${{ steps.versioning.outputs.changelog }}
          VERSION: ${{ steps.versioning.outputs.version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
